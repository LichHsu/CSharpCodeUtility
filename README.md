# CSharpCodeUtility - C# ç¨‹å¼ç¢¼è™•ç† MCP ä¼ºæœå™¨

`CSharpCodeUtility` æ˜¯ä¸€å€‹å°ˆç‚º AI Agent è¨­è¨ˆçš„ Model Context Protocol (MCP) ä¼ºæœå™¨ï¼Œæ—¨åœ¨æä¾›é«˜æ•ˆã€ä½ Token æ¶ˆè€—çš„ C# åŸå§‹ç¢¼æ“ä½œèƒ½åŠ›ã€‚å®ƒåˆ©ç”¨ Roslyn (Microsoft.CodeAnalysis) é€²è¡Œç²¾ç¢ºçš„èªæ³•åˆ†æï¼Œä¸¦æ”¯æ´ã€Œè¨˜æ†¶é«”å…§å·¥ä½œéšæ®µ (In-Memory Session)ã€ï¼Œé¿å…é »ç¹çš„ç£ç¢Ÿè®€å¯«ã€‚

## åŠŸèƒ½ç‰¹è‰²

*   **çµæ§‹åŒ–è§£æ (`get_code_structure`)**ï¼šå¿«é€Ÿå–å¾—ç¨‹å¼ç¢¼çš„æ‰å¹³åŒ–çµæ§‹ï¼ˆé¡åˆ¥ã€æ–¹æ³•ã€å±¬æ€§ï¼‰ï¼Œé©åˆ AI å¿«é€Ÿç†è§£æª”æ¡ˆå…¨è²Œã€‚
*   **ç²¾ç¢ºè®€å– (`get_method`)**ï¼šåƒ…è®€å–ç‰¹å®šæ–¹æ³•çš„å¯¦ä½œå…§å®¹ï¼Œå¤§å¹…ç¯€çœ Context Windowã€‚
*   **èªæ³•æ„ŸçŸ¥ä¿®æ”¹ (`update_method`)**ï¼šä½¿ç”¨ Roslyn é€²è¡Œæ–¹æ³•çš„å®‰å…¨æ›¿æ›ï¼Œç¢ºä¿æ ¼å¼æ­£ç¢ºã€‚
*   **æ™ºæ…§å¼•ç”¨ (`add_using`)**ï¼šè‡ªå‹•æª¢æŸ¥ä¸¦æ·»åŠ ç¼ºå°‘çš„ `using` æŒ‡ä»¤ã€‚
*   **è¨˜æ†¶é«”å…§å·¥ä½œéšæ®µ (`Session Management`)**ï¼š
    *   æ”¯æ´åœ¨è¨˜æ†¶é«”ä¸­é€²è¡Œå¤šæ¬¡ä¿®æ”¹ï¼Œæœ€å¾Œå†ä¸€æ¬¡æ€§å¯«å…¥ç£ç¢Ÿã€‚
    *   é¿å…å› ä¸­é–“ç‹€æ…‹éŒ¯èª¤è€Œç ´å£åŸå§‹æª”æ¡ˆã€‚

## è¨­è¨ˆç†å¿µï¼šAgent-First (AI å„ªå…ˆ)

æœ¬å·¥å…·çš„æ ¸å¿ƒè¨­è¨ˆç›®æ¨™æ˜¯**æ¶ˆé™¤ AI åœ¨ç·¨è¼¯ç¨‹å¼ç¢¼æ™‚å¸¸è¦‹çš„éŒ¯èª¤**ï¼š

1.  **é¿å…èªæ³•éŒ¯èª¤**ï¼šAI å¸¸å› æ¼å¯«å¤§æ‹¬è™Ÿ `}` æˆ–åˆ†è™Ÿ `;` å°è‡´ç·¨è­¯å¤±æ•—ã€‚æœ¬å·¥å…·é€é Roslyn èªæ³•æ¨¹æ“ä½œï¼Œç¢ºä¿çµæ§‹å®Œæ•´æ€§ã€‚
2.  **æ¸›å°‘ Token æ¶ˆè€—**ï¼šAI ä¸éœ€è¦è®€å–æ•´å€‹æª”æ¡ˆä¾†ä¿®æ”¹ä¸€å€‹å°æ–¹æ³•ã€‚`get_method` è®“ AI å°ˆæ³¨æ–¼å±€éƒ¨ï¼Œå¤§å¹…æå‡ä¸Šä¸‹æ–‡æ•ˆç‡ã€‚
3.  **é˜²æ­¢å¹»è¦º (Hallucination)**ï¼šé€é `get_code_structure` æä¾›çš„ç²¾ç¢ºç´¢å¼•ï¼ŒAI èƒ½æº–ç¢ºå®šä½ç›®æ¨™ï¼Œé¿å…ä¿®æ”¹ä¸å­˜åœ¨çš„ç¨‹å¼ç¢¼ã€‚
4.  **åŸå­åŒ–æ“ä½œ**ï¼šæ‰€æœ‰çš„ä¿®æ”¹éƒ½æ˜¯é‡å°ç‰¹å®šç¯€é»ï¼ˆå¦‚ Method, Propertyï¼‰ï¼Œè€Œéè„†å¼±çš„è¡Œè™Ÿæˆ–å­—ä¸²æ›¿æ›ã€‚

é€™æ˜¯ä¸€å€‹**çµ¦ AI ä½¿ç”¨çš„ Power Tool**ï¼Œæ—¨åœ¨è®“ AI æˆç‚ºæ›´å¯é çš„ C# å·¥ç¨‹å¸«ã€‚

## å®‰è£èˆ‡åŸ·è¡Œ

æœ¬å°ˆæ¡ˆç‚º .NET 10.0 Console æ‡‰ç”¨ç¨‹å¼ã€‚

### å»ºç½®
```bash
dotnet build
```

### åŸ·è¡Œæ¸¬è©¦
```bash
dotnet run -- --test
```

### ä½œç‚º MCP ä¼ºæœå™¨åŸ·è¡Œ
```bash
dotnet run
```
ï¼ˆè«‹å°‡æ­¤æŒ‡ä»¤é…ç½®æ–¼æ‚¨çš„ MCP å®¢æˆ¶ç«¯è¨­å®šæª”ä¸­ï¼‰

## å¯ç”¨å·¥å…· (Tools)

### 1. `get_code_structure`
è§£æ C# ç¨‹å¼ç¢¼ä¸¦å›å‚³çµæ§‹åˆ—è¡¨ã€‚

*   **åƒæ•¸**:
    *   `path` (string, optional): æª”æ¡ˆè·¯å¾‘ã€‚
    *   `sessionId` (string, optional): å·¥ä½œéšæ®µ IDã€‚
*   **å›å‚³**: `List<CsharpCodeItem>` (åŒ…å« Type, Name, Signature, StartLine, EndLine ç­‰)ã€‚

### 2. `get_method`
å–å¾—ç‰¹å®šæ–¹æ³•çš„å¯¦ä½œå…§å®¹ã€‚

*   **åƒæ•¸**:
    *   `methodName` (string): æ–¹æ³•åç¨±ã€‚
    *   `path` / `sessionId`: ä¾†æºã€‚
*   **å›å‚³**: æ–¹æ³•çš„å®Œæ•´ç¨‹å¼ç¢¼å­—ä¸²ã€‚

### 3. `update_method`
æ›´æ–°ç‰¹å®šæ–¹æ³•çš„å¯¦ä½œå…§å®¹ã€‚

*   **åƒæ•¸**:
    *   `methodName` (string): ç›®æ¨™æ–¹æ³•åç¨±ã€‚
    *   `newBody` (string): æ–°çš„æ–¹æ³•æœ¬é«” (ä¸åŒ…å«å¤§æ‹¬è™Ÿå¤–çš„ç°½ç« ï¼Œåƒ…å…§éƒ¨é™³è¿°å¥)ã€‚
    *   `path` / `sessionId`: ç›®æ¨™ã€‚
*   **å›å‚³**: æ›´æ–°çµæœè¨Šæ¯ã€‚

### 4. `add_using`
æ·»åŠ  `using` æŒ‡ä»¤ã€‚

*   **åƒæ•¸**:
    *   `namespace` (string): è¦å¼•å…¥çš„å‘½åç©ºé–“ (ä¾‹å¦‚ "System.IO")ã€‚
    *   `path` / `sessionId`: ç›®æ¨™ã€‚

### 5. `fix_namespace_and_usings`
è‡ªå‹•ä¿®æ­£å‘½åç©ºé–“ä¸¦æ·»åŠ å¿…è¦çš„ Usingsã€‚
*   **åƒæ•¸**:
    *   `directory`: æƒæç›®éŒ„
    *   `projectRoot`: å°ˆæ¡ˆæ ¹ç›®éŒ„ (ç”¨æ–¼åˆ¤æ–·å‘½åç©ºé–“)
    *   `rootNamespace`: å°ˆæ¡ˆæ ¹å‘½åç©ºé–“
    *   `extraUsings`: é¡å¤–éœ€è¦å¼•å…¥çš„å‘½åç©ºé–“åˆ—è¡¨

### 6. å·¥ä½œéšæ®µç®¡ç† (Session Management)
*   `start_csharp_session`: é–‹å§‹ä¸€å€‹æ–°çš„ç·¨è¼¯å·¥ä½œéšæ®µ (å¯è¼‰å…¥æª”æ¡ˆ)ã€‚
*   `update_csharp_session`: ç›´æ¥æ›´æ–°å·¥ä½œéšæ®µå…§å®¹ã€‚
*   `save_csharp_session`: å°‡å·¥ä½œéšæ®µå…§å®¹å¯«å›ç£ç¢Ÿã€‚

## ğŸ’» CLI å‘½ä»¤åˆ—æ¨¡å¼ (CLI Mode)

æœ¬å·¥å…·æ”¯æ´ç›´æ¥é€éå‘½ä»¤åˆ—åŸ·è¡Œæ‰¹æ¬¡é‡æ§‹ï¼š

### ä¿®æ­£å‘½åç©ºé–“
```bash
dotnet run -- fix-namespace --path "D:\Projects\MyProject" --root "MyProject"
```


## ä½¿ç”¨ç¯„ä¾‹ (JSON-RPC)

### è®€å–æª”æ¡ˆçµæ§‹
```json
{
  "name": "get_code_structure",
  "arguments": {
    "path": "D:\\Projects\\MyClass.cs"
  }
}
```

### é–‹å§‹å·¥ä½œéšæ®µä¸¦ä¿®æ”¹æ–¹æ³•
```json
// 1. Start Session
{
  "name": "start_csharp_session",
  "arguments": { "path": "D:\\Projects\\MyClass.cs" }
}
// Returns: { "id": "session-123", ... }

// 2. Update Method
{
  "name": "update_method",
  "arguments": {
    "sessionId": "session-123",
    "methodName": "Calculate",
    "newBody": "return x + y;"
  }
}

// 3. Save
{
  "name": "save_csharp_session",
  "arguments": { "sessionId": "session-123" }
}
```
